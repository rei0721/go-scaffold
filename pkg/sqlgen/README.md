# SQLGen 使用文档

企业级 SQL 代码生成工具，支持多数据库和多种输出格式。

## 功能概览

- ✅ **多数据库支持**: MySQL, PostgreSQL, SQLite
- ✅ **双模式输出**: Go 代码生成 + SQL DDL 脚本
- ✅ **完整 CRUD**: Model + DAO 层
- ✅ **智能映射**: 自动类型转换和 Tag 生成

## 快速开始

### 命令行参数

```bash
go run ./cmd/server sqlgen [options]

选项:
  -t, --type string    数据库类型 (sqlite|mysql|postgres) [默认: sqlite]
  -m, --mode string    生成模式 (ddl|model) [默认: ddl]
```

### 示例

#### 1. SQLite DDL 生成

```bash
go run ./cmd/server sqlgen --type=sqlite --mode=ddl
```

生成 `schema.sql` 包含：

- CREATE TABLE 语句
- INDEX 定义
- FOREIGN KEY 约束

#### 2. SQLite 代码生成

```bash
go run ./cmd/server sqlgen --type=sqlite --mode=model
```

生成文件：

- `models/users.go` - User 模型
- `models/posts.go` - Post 模型
- `dao/users_dao.go` - User DAO (含 CRUD)
- `dao/posts_dao.go` - Post DAO

#### 3. MySQL DDL 生成

```bash
go run ./cmd/server sqlgen --type=mysql --mode=ddl
```

支持 MySQL 特性：

- AUTO_INCREMENT
- ENGINE=InnoDB
- utf8mb4 字符集
- 表/字段注释

#### 4. MySQL 代码生成

```bash
go run ./cmd/server sqlgen --type=mysql --mode=model
```

## 生成内容示例

### DDL 脚本 (schema.sql)

```sql
-- ============================================================
-- Database: testdb
-- Generated by: sqlgen
-- Database Type: mysql
-- ============================================================

CREATE TABLE `users` (
    `id` BIGINT PRIMARY KEY AUTO_INCREMENT,
    `username` VARCHAR(100) NOT NULL,
    `email` VARCHAR(255) NOT NULL,
    `password` VARCHAR(255) NOT NULL,
    `status` TINYINT(1) DEFAULT 1,
    `created_at` TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    `updated_at` TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

CREATE UNIQUE INDEX `idx_email` ON `users` (`email`);
```

### Go Model

```go
// User 用户模型
type User struct {
    ID        int64      `json:"id" gorm:"primaryKey;autoIncrement"`
    Username  string     `json:"username" gorm:"not null"`
    Email     string     `json:"email" gorm:"not null"`
    Password  string     `json:"-" gorm:"not null"`
    Status    *int       `json:"status,omitempty"`
    CreatedAt *time.Time `json:"created_at,omitempty"`
    UpdatedAt *time.Time `json:"updated_at,omitempty"`
}

func (User) TableName() string {
    return "users"
}
```

### Go DAO

```go
type UserDAO struct {
    db *sql.DB
}

func (d *UserDAO) FindByID(ctx context.Context, id int64) (*User, error)
func (d *UserDAO) Create(ctx context.Context, m *User) error
func (d *UserDAO) Update(ctx context.Context, m *User) error
func (d *UserDAO) Delete(ctx context.Context, id int64) error
```

## API 使用

### 代码生成

```go
import "github.com/rei0721/rei0721/pkg/sqlgen"

config := sqlgen.DefaultConfig()
config.DatabaseType = sqlgen.DatabaseMySQL
config.Target.Model = true
config.Target.DAO = true

gen, _ := sqlgen.NewGeneratorSimple(config)
schema, _ := gen.Parse(ctx, db)
gen.Generate(ctx, schema, "./generated")
```

### DDL 脚本生成

```go
config := sqlgen.DefaultConfig()
config.DatabaseType = sqlgen.DatabaseMySQL
config.Target.Migration = true  // 启用 DDL

gen, _ := sqlgen.NewGeneratorSimple(config)
schema, _ := gen.Parse(ctx, db)
gen.Generate(ctx, schema, "./generated")  // 生成 schema.sql

// 或单独生成 DDL
ddlGen := sqlgen.NewDDLGenerator(config)
ddl, _ := ddlGen.GenerateDDL(schema)
fmt.Println(ddl)
```

## 配置选项

| 配置项             | 类型   | 默认值      | 说明       |
| ------------------ | ------ | ----------- | ---------- |
| `DatabaseType`     | string | sqlite      | 数据库类型 |
| `OutputDir`        | string | ./generated | 输出目录   |
| `Target.Model`     | bool   | true        | 生成模型   |
| `Target.DAO`       | bool   | false       | 生成 DAO   |
| `Target.Migration` | bool   | false       | 生成 DDL   |
| `Tags.JSON`        | bool   | true        | JSON tag   |
| `Tags.GORM`        | bool   | true        | GORM tag   |

## 数据库连接

### SQLite

```go
db, _ := sql.Open("sqlite3", "./test.db")
```

### MySQL

```go
db, _ := sql.Open("mysql", "user:pass@tcp(host:3306)/dbname")
```

### PostgreSQL

```go
db, _ := sql.Open("postgres", "postgres://user:pass@host:5432/dbname")
```

## 最佳实践

1. **DDL 优先**: 先生成 DDL 脚本审查表结构
2. **版本控制**: 将生成的代码提交到 Git
3. **增量更新**: 表结构变更后重新生成
4. **自定义模板**: 通过 `TemplatePath` 配置自定义模板

## 故障排除

**Q: 生成的文件在哪里？**  
A: 默认在 `./generated/` 目录，包含 `models/`, `dao/`, `schema.sql`

**Q: 如何修改生成的包名？**  
A: 设置 `config.PackageName = "yourpkg"`

**Q: 支持联合主键吗？**  
A: 支持，会在 DDL 中正确生成 `PRIMARY KEY (col1, col2)`

**Q: password 字段如何处理？**  
A: 自动设置 `json:"-"` 忽略序列化
